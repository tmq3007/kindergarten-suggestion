package fa.pjb.back.service.impl;

import fa.pjb.back.common.exception._11xx_email.EmailAlreadyExistedException;
import fa.pjb.back.common.exception._13xx_school.SchoolNotFoundException;
import fa.pjb.back.common.exception._14xx_data.InvalidDataException;
import fa.pjb.back.common.exception._14xx_data.InvalidFileFormatException;
import fa.pjb.back.common.exception._14xx_data.PhoneExistedException;
import fa.pjb.back.common.exception._14xx_data.UploadFileException;
import fa.pjb.back.model.dto.AddSchoolDTO;
import fa.pjb.back.model.dto.SchoolUpdateDTO;
import fa.pjb.back.model.entity.Facility;
import fa.pjb.back.model.entity.Media;
import fa.pjb.back.model.entity.School;
import fa.pjb.back.model.entity.Utility;
import fa.pjb.back.model.mapper.SchoolMapper;
import fa.pjb.back.model.vo.ImageVO;
import fa.pjb.back.model.vo.SchoolDetailVO;
import fa.pjb.back.model.vo.SchoolListVO;
import fa.pjb.back.repository.FacilityRepository;
import fa.pjb.back.repository.MediaRepository;
import fa.pjb.back.repository.SchoolRepository;
import fa.pjb.back.repository.UtilityRepository;
import fa.pjb.back.service.GGDriveImageService;
import fa.pjb.back.service.SchoolService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.apache.tika.Tika;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Set;

import static fa.pjb.back.model.enums.FileFolderEnum.SCHOOL_IMAGES;


@Slf4j
@RequiredArgsConstructor
@Service
public class SchoolServiceImpl implements SchoolService {
    private static final long MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
    private static final List<String> ALLOWED_MIME_TYPES = Arrays.asList("image/jpeg", "image/png", "image/gif");

    private final SchoolRepository schoolRepository;
    private final FacilityRepository facilityRepository;
    private final UtilityRepository utilityRepository;
    private final MediaRepository mediaRepository;
    private final SchoolMapper schoolMapper;
    private final GGDriveImageService imageService;
    private static final Tika tika = new Tika();

    @Override
    public SchoolDetailVO getSchoolInfo(Integer schoolId) {
        School school = schoolRepository.findById(schoolId).orElseThrow(SchoolNotFoundException::new);
        return schoolMapper.toSchoolDetailVO(school);
    }

    @Transactional
    @Override
    public SchoolDetailVO addSchool(AddSchoolDTO schoolDTO, List<MultipartFile> image) {
        if (checkEmailExists(schoolDTO.email())) {
            throw new EmailAlreadyExistedException("This email is already in used");
        }
        if (checkPhoneExists(schoolDTO.phone())) {
            throw new PhoneExistedException("This phone is already in used");
        }
        School school = schoolMapper.toSchool(schoolDTO);
        List<ImageVO> imageVOList = null;

        //Get existing facilities from DB
        Set<Facility> existingFacilities = facilityRepository.findAllByFidIn(schoolDTO.facilities());

        //Validate: Check if all requested fids exist in the database
        if (existingFacilities.size() != school.getFacilities().size()) {
            throw new InvalidDataException("Some facilities do not exist in the database");
        }
        //Get existing utilities from DB
        Set<Utility> existingUtilities = utilityRepository.findAllByUidIn(schoolDTO.utilities());

        //Validate: Check if all requested uids exist in the database
        if (existingUtilities.size() != school.getUtilities().size()) {
            throw new InvalidDataException("Some utilities do not exist in the database");
        }

        school.setPostedDate(LocalDate.now());
        School newSchool = schoolRepository.save(school);

        // Validate and upload images (if provided)
        if (image != null) {
            for (MultipartFile file : image) {
                // Check file size
                if (file.getSize() > MAX_FILE_SIZE) {
                    throw new InvalidFileFormatException("File cannot exceed 5MB");
                }
                // Check file type
                try {
                    String mimeType = tika.detect(file.getBytes()); // Detect MIME type
                    if (!ALLOWED_MIME_TYPES.contains(mimeType)) {
                        throw new InvalidFileFormatException("Invalid file type: " + file.getOriginalFilename() + ". Allowed: JPEG, PNG, GIF.");
                    }
                } catch (IOException e) {
                    throw new InvalidFileFormatException("Error when processing file");
                }
            }

            //Upload images
            try {
                imageVOList = imageService.uploadListImages(
                        imageService.convertMultiPartFileToFile(image),
                        "School_" + newSchool.getId() + "Image_",
                        SCHOOL_IMAGES
                );
            } catch (IOException e) {
                throw new UploadFileException("Error while uploading images" + e.getMessage());
            }
            List<Media> temp = new ArrayList<>();
            for (ImageVO imageVO : imageVOList) {
                if (imageVO.status() == 200) {
                    Media media = new Media();
                    media.setUrl(imageVO.url());
                    media.setSize(String.valueOf(imageVO.size()));
                    media.setCloudId(imageVO.fileId());
                    media.setFilename(imageVO.fileName());
                    media.setType("image/png");
                    media.setUploadTime(LocalDate.now());
                    media.setSchool(newSchool);
                    temp.add(media);
                }
            }
            mediaRepository.saveAll(temp);
        }

        return schoolMapper.toSchoolDetailVO(newSchool);
    }

    @Override
    public Page<SchoolListVO> getAllSchools(String name, String province, String district,
                                            String street, String email, String phone, Pageable pageable) {
        Page<School> schoolPage = schoolRepository.findSchools(name, province, district, street, email, phone, pageable);
        return schoolPage.map(schoolMapper::toSchoolListVO);
    }

    @Override
    public Page<SchoolDetailVO> getSchoolsByUserId(Integer userId, Pageable pageable, String name) {
        Page<School> schoolPage = schoolRepository.findSchoolsByUserId(userId, name, pageable);
        return schoolPage.map(schoolMapper::toSchoolDetailVO);
    }

    @Override
    public boolean checkEmailExists(String email) {
        return schoolRepository.existsByEmail(email);
    }

    @Override
    public boolean checkPhoneExists(String phone) {
        return schoolRepository.existsByPhone(phone);
    }

    @PreAuthorize("hasRole('ROLE_ADMIN')")
    @Override
    @Transactional
    public SchoolDetailVO updateSchoolByAdmin(SchoolUpdateDTO schoolDTO, List<MultipartFile> images) {
        log.info("=========== school service: updateSchoolByAdmin ===============");

        // 1️⃣ Kiểm tra xem trường học có tồn tại không
        School school = schoolRepository.findById(schoolDTO.id())
                .orElseThrow(SchoolNotFoundException::new);


        // 3️⃣ Cập nhật thông tin từ DTO vào entity
        // 3️⃣ Cập nhật thông tin từ DTO vào entity
        school.setName(schoolDTO.name());
        school.setSchoolType(schoolDTO.schoolType());
        school.setProvince(schoolDTO.province());
        school.setDistrict(schoolDTO.district());
        school.setWard(schoolDTO.ward());
        school.setStreet(schoolDTO.street());
        school.setEmail(schoolDTO.email());
        school.setPhone(schoolDTO.phone());
        school.setReceivingAge(schoolDTO.receivingAge());
        school.setEducationMethod(schoolDTO.educationMethod());
        school.setFeeFrom(schoolDTO.feeFrom());
        school.setFeeTo(schoolDTO.feeTo());
        school.setWebsite(schoolDTO.website());
        school.setDescription(schoolDTO.description());



        school.setStatus((byte) 1);
        log.info("school: {}", school);

        // 4️⃣ Cập nhật Facilities
        Set<Facility> existingFacilities = facilityRepository.findAllByFidIn(schoolDTO.facilities());
        if (existingFacilities.size() != schoolDTO.facilities().size()) {
            throw new InvalidDataException("Some facilities do not exist in the database");
        }
        school.setFacilities(existingFacilities);

        // 5️⃣ Cập nhật Utilities
        Set<Utility> existingUtilities = utilityRepository.findAllByUidIn(schoolDTO.utilities());
        if (existingUtilities.size() != schoolDTO.utilities().size()) {
            throw new InvalidDataException("Some utilities do not exist in the database");
        }
        school.setUtilities(existingUtilities);

        // 6️⃣ Cập nhật hình ảnh nếu có upload mới
        if (images != null && !images.isEmpty()) {
            List<ImageVO> imageVOList = new ArrayList<>();

            // Xóa hình ảnh cũ
            mediaRepository.deleteAllBySchool(school);

            // Validate và upload hình ảnh mới
            for (MultipartFile file : images) {
                if (file.getSize() > MAX_FILE_SIZE) {
                    throw new InvalidFileFormatException("File cannot exceed 5MB");
                }
                try {
                    String mimeType = tika.detect(file.getBytes());
                    if (!ALLOWED_MIME_TYPES.contains(mimeType)) {
                        throw new InvalidFileFormatException("Invalid file type: " + file.getOriginalFilename());
                    }
                } catch (IOException e) {
                    throw new UploadFileException("Error processing file: " + e.getMessage());
                }
            }

            try {
                imageVOList = imageService.uploadListImages(
                        imageService.convertMultiPartFileToFile(images),
                        "School_" + school.getId() + "_Image_",
                        SCHOOL_IMAGES
                );
            } catch (IOException e) {
                throw new UploadFileException("Error uploading images: " + e.getMessage());
            }

            List<Media> newImages = new ArrayList<>();
            for (ImageVO imageVO : imageVOList) {
                if (imageVO.status() == 200) {
                    Media media = new Media();
                    media.setUrl(imageVO.url());
                    media.setSize(String.valueOf(imageVO.size()));
                    media.setCloudId(imageVO.fileId());
                    media.setFilename(imageVO.fileName());
                    media.setType("image/png");
                    media.setUploadTime(LocalDate.now());
                    media.setSchool(school);
                    newImages.add(media);
                }
            }
            mediaRepository.saveAll(newImages);
        }

        // 7️⃣ Lưu dữ liệu cập nhật
        schoolRepository.save(school);

        return schoolMapper.toSchoolDetailVO(school);
    }

}
