stages:
  - build
  - test
  - deploy
  - push-to-company-gitlab

variables:
  REGISTRY: registry.gitlab.com/pjb_01_g1/kindergarten-suggestion-system
  FRONTEND_IMAGE: $REGISTRY/kss_front
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  DOCKER_BUILDKIT: "1" # âœ… Sá»­ dá»¥ng BuildKit Ä‘á»ƒ build Docker mÃ  khÃ´ng cáº§n docker:dind
  BUILDKIT_PROGRESS: "plain"

default:
  image: docker:20.10.16

before_script:
  - apk add --no-cache docker
  - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY

# ğŸ›  Build Docker Image - Chá»‰ build khi cÃ³ thay Ä‘á»•i trong front/
build-job:
  stage: build
  script:
    - export IMAGE_TAG=$FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA

    # Kiá»ƒm tra xem cÃ³ thay Ä‘á»•i trong thÆ° má»¥c front/ khÃ´ng
    - |
      if git diff --quiet HEAD~1 -- front/; then
        echo "No changes in front/, skipping build."
        exit 0
      fi

    # Build vÃ  push Docker image vá»›i commit hash tag (dÃ¹ng BuildKit thay vÃ¬ docker:dind)
    - docker build --progress=plain --pull --rm -t $IMAGE_TAG -f ./front/Dockerfile ./front
    - docker push $IMAGE_TAG
  artifacts:
    paths:
      - front/.next/

# ğŸš€ Deploy lÃªn EC2
deploy-ec2:
  stage: deploy
  image: alpine
  dependencies:
    - build-job
  before_script:
    - apk add --no-cache openssh rsync
  script:
    - echo "$SSH_PRIVATE_KEY" > private_key && chmod 600 private_key

    # Cáº¥p quyá»n cho ec2-user trÃªn EC2
    - ssh -i private_key -o StrictHostKeyChecking=no ec2-user@$EC2_HOST "sudo mkdir -p /var/www/kindergarten-suggestion-system && sudo chown -R ec2-user:ec2-user /var/www/kindergarten-suggestion-system"

    # XÃ³a thÆ° má»¥c cÅ© Ä‘á»ƒ trÃ¡nh lá»—i Ä‘á»“ng bá»™
    - ssh -i private_key -o StrictHostKeyChecking=no ec2-user@$EC2_HOST "rm -rf /var/www/kindergarten-suggestion-system/*"

    # Äá»“ng bá»™ code tá»« GitLab Runner lÃªn EC2
    - rsync -avz -e "ssh -i private_key -o StrictHostKeyChecking=no" ./ ec2-user@$EC2_HOST:/var/www/kindergarten-suggestion-system/ --exclude node_modules --exclude .git

    # SSH vÃ o EC2 Ä‘á»ƒ pull Docker image má»›i nháº¥t vÃ  khá»Ÿi Ä‘á»™ng láº¡i container
    - |
      ssh -i private_key -o StrictHostKeyChecking=no ec2-user@$EC2_HOST << 'EOF'
        export IMAGE_TAG=$FRONTEND_IMAGE:$CI_COMMIT_SHORT_SHA
        sudo docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
      
        # Kiá»ƒm tra xem image Ä‘Ã£ tá»“n táº¡i trÃªn mÃ¡y chÆ°a, náº¿u chÆ°a thÃ¬ pull vá»
        if ! sudo docker images | grep -q "$IMAGE_TAG"; then
          sudo docker pull $IMAGE_TAG
        fi
      
        # Dá»n dáº¹p container, image, volume cÅ© Ä‘á»ƒ trÃ¡nh háº¿t dung lÆ°á»£ng
        sudo docker container prune -f
        sudo docker image prune -af
        sudo docker volume prune -f

        # Khá»Ÿi Ä‘á»™ng láº¡i container
        cd /var/www/kindergarten-suggestion-system
        sudo docker-compose down
        sudo docker-compose up -d
      EOF
  only:
    - main
  environment:
    name: production
    url: http://$EC2_HOST

# ğŸ”„ Push lÃªn GitLab ná»™i bá»™
push-to-company-gitlab:
  stage: push-to-company-gitlab
  image: alpine
  dependencies:
    - deploy-ec2
  before_script:
    - apk add --no-cache git rsync
  script:
    - git config --global user.name "hieungo"
    - git config --global user.email "hieunmhe182607@fpt.edu.vn"

    # Kiá»ƒm tra náº¿u nhÃ¡nh feature-branch Ä‘Ã£ tá»“n táº¡i thÃ¬ xÃ³a Ä‘i trÆ°á»›c khi táº¡o láº¡i
    - git branch -D feature-branch || true
    - git checkout -b feature-branch

    # Cáº¥u hÃ¬nh GitLab ná»™i bá»™
    - git remote remove origin || true
    - git remote add origin https://oauth2:$COMPANY_GITLAB_TOKEN@git.fa.edu.vn/hn25_cpl_pjb_01/hn25_cpl_pjb_01_g1/kindergarten-suggestion.git

    # Push code lÃªn GitLab ná»™i bá»™
    - git push -uf origin feature-branch
  only:
    - main
