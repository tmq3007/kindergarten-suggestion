'use client';
import React, {Fragment, useEffect, useRef, useState} from 'react';
import {FolderOpenOutlined, HomeOutlined, LeftOutlined, RightOutlined} from '@ant-design/icons';
import {Button, ConfigProvider, Layout, Menu} from 'antd';
import Link from 'next/link';
import {forbidden, unauthorized} from 'next/navigation';
import {useSelector} from 'react-redux';
import {RootState} from '@/redux/store';
import {ROLES} from '@/lib/constants';
import {Resizable} from 'react-resizable';
import 'react-resizable/css/styles.css';
import Sider from 'antd/es/layout/Sider';
import {Content} from 'antd/es/layout/layout';

export default function AdminLayout({children}: { children: React.ReactNode }) {
    const [collapsed, setCollapsed] = useState(false);
    const user = useSelector((state: RootState) => state.user);
    const role = user.role;

    if (!role) {
        unauthorized();
    }

    const isLoggingOut = useRef(false);
    useEffect(() => {
        if (role !== ROLES.SCHOOL_OWNER && !isLoggingOut.current) {
            forbidden();
        }
    }, [role]);

    const [siderWidth, setSiderWidth] = useState(250);
    const onResize = (event: any, {size}: { size: { width: number } }) => {
        setSiderWidth(size.width);
    };

    return (
        <Fragment>
            <Layout style={{minHeight: '100vh'}}>
                <ConfigProvider theme={{components: {Menu: {iconSize: 20}}}}>
                    <div className="relative hidden md:block">
                        <Resizable
                            width={siderWidth}
                            height={Infinity}
                            onResize={onResize}
                            minConstraints={[200, Infinity]}
                            maxConstraints={[350, Infinity]}
                            handle={<div className="react-resizable-handle" style={{width: 5, cursor: 'ew-resize'}}/>}
                        >
                            <Sider
                                width={siderWidth}
                                collapsed={collapsed}
                                className="pt-20 h-full"
                            >
                                <Menu
                                    theme="dark"
                                    mode="inline"
                                    defaultSelectedKeys={['1']}
                                    items={[
                                        {key: '1', icon: <HomeOutlined/>, label: <Link href="">My School</Link>},
                                        {key: '2', icon: <FolderOpenOutlined/>, label: <Link href="">My Draft</Link>},
                                    ]}
                                />
                            </Sider>
                        </Resizable>

                        <Button
                            className="absolute top-[50%] -right-4 z-10 bg-teal-300 border-teal-400 !hover:bg-teal-400"
                            shape="circle"
                            icon={collapsed ? <RightOutlined/> : <LeftOutlined/>}
                            onClick={() => setCollapsed(!collapsed)}
                        />
                    </div>
                </ConfigProvider>

                <Layout>
                    <Content style={{padding: 20, minHeight: 280, paddingTop: 200}}>{children}</Content>
                </Layout>
            </Layout>
        </Fragment>
    );
}